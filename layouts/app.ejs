<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="<%= description %>"/>
    <title><%= title %></title>
    <link rel="icon" href="<%= pathTo("favicon.ico") %>" />
    <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/styles/default.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="<%= pathTo("app.css") %>" rel="stylesheet">
  </head>
  <body>
    <header>
      <h2 id="siteheadline"><span id="sitelogo">Â¶</span><a href="<%= pathTo("/") %>">Charlie Harrington</a></h2>
      <div id="topnav">
        <a href="<%= pathTo("about") %>">About</a>
        <span>â€¢</span>
        <a href="<%= pathTo("library") %>">Library</a>
        <span>â€¢</span>
        <a href="<%= pathTo("rss.xml") %>">RSS</a>
      </div>
    </header>
    <div id="contents">
      <%if (title !== "About" && title !== "Charlie Harrington" && title !== "Library" && title !== "Books" && title !== "Walkingman") { %>
        <h1 class="title"><%= title %></h1>
        <h3 class="subtitle"><%= date %></h3>
        <div class="borderLine"></div>
      <% } %>
      <%if (title === "Library") { %>
        <div id="the-library">
          <h3>Enter a SQL query to search my book list:</h3>
          <form id="library-form">
            <p
              contentEditable
              id="library-input"
              class="librarySelect"
            >
              select author, title, genre, date_read, review from library where year_read in (2022, 2021);
            </p>
            <button id="library-button">Search Charlie's books</button>
          </form>
          <div id="booklist"></div>
        </div>
      <% } %>
      <%- body %>
    </div>
    <footer>
      <div>
        <form
          action="https://tinyletter.com/whatrocks"
          method="post"
          target="popupwindow"
          onsubmit="window.open('https://tinyletter.com/whatrocks', 'popupwindow', 'scrollbars=yes,width=800,height=600');return true"
        >
        <input
            class="subscribeInput"
            type="text"
            placeholder="Get updates on my writing"
            name="email"
            id="tlemail"
          />
          <input type="hidden" value="1" name="embed" />
          <input class="subscribeButton" type="submit" value="Update Me ðŸ‘‹" />
        </form>
        <p class="warning">
          The almost-never newsletter. I won't spam you, and you can unsubscribe
          anytime.
        </p>
        <div class="copyright">
          <span>Â© 2022 Charlie Harrington</span>
          <span> | </span>
          <span>
            <a
              href="https://www.charlieharrington.com/rss.xml"
              target="_blank"
              rel="noopener noreferrer"
            >
              RSS feed
            </a>
          </span>
          <span> | </span>
          <span>
            <a
              href="https://www.twitter.com/whatrocks"
              target="_blank"
              rel="noopener noreferrer"
            >
              Follow @whatrocks on Twitter
            </a>
          </span>
        </div>
      </div>
    </footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script>
      // Charlie's library script
      document.addEventListener("DOMContentLoaded", function() {
        function printBooks(books) {
          const booklist = document.getElementById("booklist");
          booklist.innerHTML = ''
          for (let book of books) {
            if (book["cover_url"] && book["title"]) {
              prettyPrintBook(book);
            } else {
              const bookElement = document.createElement("div");
              bookElement.classList["card"];
              bookElement.innerText = Object.keys(book).reduce((accum, next)=> {
                return `${next}: ${book[next]}, ${accum}`;
              },"")
              booklist.appendChild(bookElement);
              booklist.appendChild(document.createElement("hr"))
            }
          }
        }
        function prettyPrintBook(book) {
          const booklist = document.getElementById("booklist");
          console.log("prtty!")
          const bookElement = document.createElement("div");
          bookElement.classList = ["card"];
          const cover = document.createElement("img");
          cover.alt = `${book.title}`
          cover.src = `${book.cover_url}`;
          cover.height = "250"
          cover.width = "165";
          bookElement.appendChild(cover);
          Object.keys(book).forEach(key=> {
            const p = document.createElement("p");
            p.innerText = `${key}: ${book[key]}`;
             bookElement.appendChild(p);
          });
          booklist.appendChild(bookElement);
        }
        function fetchBooks(query, cb) {
            const xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function() {
              if (xmlhttp.readyState === XMLHttpRequest.DONE) {
                const status = xmlhttp.status;
                if (status === 0 || (status >= 200 && status < 400)) {
                    const results = JSON.parse(xmlhttp.responseText)
                    cb(results)
                } else {
                    const booklist = document.getElementById("booklist");
                    booklist.innerHTML = "That didn't work";
                }
              }
            }
            xmlhttp.open("POST", "https://roapi-library.whatrocks.repl.co/api/sql", true);
            xmlhttp.send(query);
        }
        // Only do stuff on the library page!
        const library = document.getElementById("the-library");
        if (library) {
          const libraryForm = document.getElementById("library-form");
          libraryForm.addEventListener('submit', e => {
            e.preventDefault();
            submitQuery();            
          });
        }
        function submitQuery() {
          const queryInput = document.getElementById("library-input");
          const query = queryInput.innerText.trim();
          fetchBooks(query, printBooks)
        }        
      });
    </script>
  </body>
</html>
